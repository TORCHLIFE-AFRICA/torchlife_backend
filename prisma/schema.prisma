// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

// schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum USER_ACTIVITIES {
  DONOR
  RECEIVER
}

enum USER_ROLES {
  ADMIN
  SUPER_ADMIN
  USER
  PROXY
}

model User {
  id                 String           @id @default(uuid()) @db.Uuid()
  first_name         String
  last_name          String
  password           String
  isverified         Boolean
  email              String           @unique()
  phone_number       String           @unique()
  role               USER_ROLES?      @default(USER)
  activities         USER_ACTIVITIES?
  //
  created_at         DateTime         @default(now())
  updated_at         DateTime         @updatedAt
  deleted_at         DateTime?
  //
  verified_campaigns Campaign[]       @relation(name: "verified_campaigns")
  donations          Donation[]
  payment            Payment[]
  wallet             Wallet?
  campaigns          Campaign[]       @relation(name: "campaign_owner")
  ratings            Rating[]
  fileUploads        FileUpload[]

  @@map("users")
}

model OtpToken {
  pkId       Int      @default(autoincrement())
  token      String   @unique
  userId     String
  expiryDate DateTime
}

model FileUpload {
  id           String   @id @default(uuid()) @db.Uuid()
  publicId     String   @unique
  url          String
  format       String
  resourceType String
  sizeInBytes  Int
  originalName String
  uploadedAt   DateTime @default(now())

  // ✅ Relations
  userId String? @db.Uuid()
  user   User?   @relation(fields: [userId], references: [id])

  campaignId String   @db.Uuid()
  campaign   Campaign @relation(fields: [campaignId], references: [id])

  @@map("file_uploads")
}

enum DONATION_STATUS {
  PENDING
  FAILED
  REJECTED
  SUCCESS
}

model Donation {
  id          String          @id @default(uuid()) @db.Uuid()
  amount      Int
  status      DONATION_STATUS @default(PENDING)
  //
  created_at  DateTime        @default(now())
  updated_at  DateTime        @updatedAt
  deleted_at  DateTime?
  //
  user_id     String          @db.Uuid()
  user        User            @relation(fields: [user_id], references: [id])
  campaign_id String          @db.Uuid()
  campaign    Campaign        @relation(fields: [campaign_id], references: [id])
  payment     Payment[]

  @@map("donations")
}

enum CAMPAIGN_STATUS {
  PENDING
  APPROVED
  REJECTED
}

enum CAMPAIGN_PRIORITY {
  LOW
  MEDIUM
  HIGH
}

enum CURRENCY {
  NGN
  USD
}

model Campaign {
  id            String            @id @default(uuid()) @db.Uuid()
  title         String
  story         String?
  location      String?
  priority      CAMPAIGN_PRIORITY @default(LOW)
  records       String[]
  batch         Int               @default(1)
  currency      CURRENCY          @default(NGN)
  certified_pdf String
  image_url     String
  status        CAMPAIGN_STATUS   @default(PENDING)
  deadline      DateTime
  target_amount Int
  amount_raised Int               @default(0)
  type          USER_ROLES        @default(USER)

  // Verification organization (many campaigns can be verified by one org)
  verified_by_id String  @db.Uuid()
  verified_by    User    @relation(name: "verified_campaigns", fields: [verified_by_id], references: [id])
  wallet         Wallet?

  // Optional proxy fields
  proxyName    String?
  proxyPhone   String?
  proxyEmail   String?
  proxyAddress String?
  proxyNote    String?

  // File uploads and related entities
  fileUploads FileUpload[]
  donations   Donation[]
  ratings     Rating[]

  user_id String @db.Uuid()
  user    User   @relation(name: "campaign_owner", fields: [user_id], references: [id])

  created_at DateTime  @default(now())
  updated_at DateTime  @updatedAt
  deleted_at DateTime?

  @@map("campaigns")
}

enum PAYMENT_STATUS {
  PENDING
  FAILED
  REJECTED
  SUCCESS
}

enum PAYMENT_TYPE {
  DEPOSIT
  WITHDRAWAL
  REFUND
  ADJUSTMENT
}

model Payment {
  id            String         @id @default(uuid()) @db.Uuid()
  amount        Int
  synced_at     DateTime?
  tx_ref        String
  custom_tx_ref String
  status        PAYMENT_STATUS
  comment       String?
  type          PAYMENT_TYPE
  currency      CURRENCY
  meta          Json?
  provider      String?

  created_at DateTime  @default(now())
  updated_at DateTime  @updatedAt
  deleted_at DateTime?

  donation_id String?   @db.Uuid()
  donation    Donation? @relation(fields: [donation_id], references: [id])

  user_id String? @db.Uuid()
  user    User?   @relation(fields: [user_id], references: [id])

  wallet_id String? @db.Uuid()
  wallet    Wallet? @relation(fields: [wallet_id], references: [id]) // ✅ Correct one-to-many relation

  webhook            Webhook?
  walletTransactions WalletTransaction[]
  withdrawalRequests WithdrawalRequest[]

  @@map("payments")
}

enum ACCOUNT_STATUS {
  ACTIVE
  INACTIVE
  SUSPENDED
}

model Wallet {
  id             String         @id @default(uuid()) @db.Uuid()
  balance        Int
  currency       CURRENCY       @default(NGN)
  account_status ACCOUNT_STATUS @default(ACTIVE)

  user_id     String? @unique @db.Uuid()
  campaign_id String? @unique @db.Uuid()

  user     User?     @relation(fields: [user_id], references: [id])
  campaign Campaign? @relation(fields: [campaign_id], references: [id])

  WalletTransaction WalletTransaction[]
  payments          Payment[]

  @@map("wallets")
}

model WalletTransaction {
  id          String         @id @default(uuid()) @db.Uuid()
  amount      Int
  type        PAYMENT_TYPE
  currency    CURRENCY
  status      PAYMENT_STATUS @default(PENDING)
  reference   String         @unique
  description String?
  meta        Json?

  wallet_id String @db.Uuid()
  wallet    Wallet @relation(fields: [wallet_id], references: [id], onDelete: Cascade)

  payment_id String?  @db.Uuid()
  payment    Payment? @relation(fields: [payment_id], references: [id])

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([wallet_id])
}

enum WITHDRAWAL_STATUS {
  PENDING
  PROCESSING
  SUCCESS
  FAILED
}

model WithdrawalRequest {
  id           String            @id @default(uuid()) @db.Uuid()
  user_id      String            @db.Uuid()
  wallet_id    String            @db.Uuid()
  payment_id   String?           @db.Uuid()
  payment      Payment?          @relation(fields: [payment_id], references: [id])
  amount       Int
  status       WITHDRAWAL_STATUS
  reason       String?
  initiated_at DateTime          @default(now())
  processed_at DateTime?
}

model Webhook {
  id         String    @id @default(uuid()) @db.Uuid()
  event      Json
  created_at DateTime  @default(now())
  updated_at DateTime  @updatedAt
  deleted_at DateTime?

  payment_id String?  @unique @db.Uuid()
  payment    Payment? @relation(fields: [payment_id], references: [id])

  @@map("webhooks")
}

model Rating {
  id      String  @id @default(uuid()) @db.Uuid()
  score   Int
  comment String?

  //
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt
  deleted_at  DateTime?
  //
  user_id     String    @db.Uuid()
  user        User      @relation(fields: [user_id], references: [id])
  campaign_id String    @db.Uuid()
  campaign    Campaign  @relation(fields: [campaign_id], references: [id])

  @@map("ratings")
}
